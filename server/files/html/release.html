<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>资讯发布</title>
  </head>
  <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <body style="margin:0;">
    <div id="app" class="container">
      <div class="para-title">
        <div></div>
        新闻标题
      </div>
      <input v-model='title' maxlength="20"/>
      <div class="para-title">
        <div></div>
        新闻头图
      </div>
      <input id='file' class="upload" @change="add_img" type="file" />
      <div class="para-title">
        <div></div>
        新闻详情
      </div>
      <textarea rows="10" cols="200" v-model='detail' maxlength="1000"></textarea>
      <div class="button" @click='submit'>发布</div>
      <div style="height: 60px; width: 100%;"></div>
    </div>
  </body>

  <script>
    let img
    const app = new Vue({
      el: '#app',
      data: {
        title: '',
        detail: '',
        rootUrl: 'http://47.92.247.229/'
      },
      methods: {
        add_img(event) {
          img = event.target.files[0]
        },
        submit() {
          if(this.title === '' || this.detail === ''){
            alert('请将表单填写完整！')
            return
          }
          const legalType = 'image/gif, image/jpeg, image/png, image/jpg'

          if (legalType.indexOf(img.type) == -1) {
            alert('请选择我们支持的图片格式！')
            return
          }
          if (img.size > 3145728) {
            alert('请选择3M以内的图片！')
            return
          }
          axios
            .post(`${this.rootUrl}addNews`, {
              title: this.title,
              detail: this.detail,
              format: img.name.split('.').pop()
            })
            .then(res => {
              const form = new FormData()
              form.append('news', img, res.data[0].NSID + '.' + img.name.split('.').pop())
              axios
                .post(`${this.rootUrl}addNewsImg`, form)
                .then(res => {
                  if(res.data === 'ok'){
                    alert('发布成功')
                    this.title = ''
                    this.detail = ''
                    const file = document.getElementById('file')
                    file.value = ''
                    file.outerHTML = file.outerHTML
                  }
                })
                .catch(error => {
                  alert('上传图片出错！')
                })
            })
            .catch(error => {
              alert('上传出错！')
            })
        }
      },
      mounted(){
        this.title = ''
        this.detail = ''
      }
    })
  </script>
  <style>
    .container {
      height: 100%;
      width: 90%;
      padding: 0 5%;
    }
    .container .para-title {
      display: flex;
      align-items: center;
      font: bold 32px/100px false;
      color: #424242;
    }
    .container .para-title div {
      margin-right: 20px;
      height: 45px;
      width: 10px;
      background: #011458;
    }
    .container .sub-info {
      font: 30px/50px false;
      display: flex;
      align-items: flex-start;
    }
    .container .sub-info > div:nth-child(1) {
      color: #808080;
      width: 25%;
    }
    .container .sub-info > .div:nth-child(2) {
      width: 75%;
    }
    .container .title {
      font: bold 42px/70px false;
      margin: 30px 0;
    }
    .container .info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font: 30px/50px false;
      color: #808080;
    }
    .container .detail {
      margin: 10px 0;
      font: 32px/40px false;
      text-align: justify;
    }
    .container .location {
      font: 30px/80px false;
      color: #e64340;
    }
    .container img {
      margin: 0 20px;
    }
    input {
      width: 100%;
      height: 40px;
      font: 20px/40px not specified;
    }
    textarea {
      width: 100%;
      font: 18px/40px not specified;
    }
    .button {
      height: 100px;
      width: 250px;
      font: 40px/100px not specified;
      background: red;
      border-radius: 10px;
      margin-left: calc(50% - 125px);
      margin-top: 50px;
      text-align: center;
      color: white;
    }
    .button:hover {
      opacity: 0.5;
    }
  </style>
</html>
